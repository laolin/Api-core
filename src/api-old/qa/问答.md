问答模块设计
============
*2016-11-26*



1. 实现的功能
    #### 所有向用户推送的消息记录
    #### 用户阅读消息情况
    #### 支持实现OA事件处理
1. 问答模块组成
    #### 用户提问
    #### 专家回答
    #### 用户评价
    #### 编导归档
1. 问答的操作
    1. 用户操作
        1. 新建草稿
            ### **草稿**，指未曾发出提问的提问
            ### 每个用户仅能保存一份
        1. 保存草稿
            ### 每个用户仅能保存一份
        1. 发出提问
            ### 发出提问后，10分钟后，为正式发出提问，不再允许收回
        1. 收回提问，成为收回稿
            ### 发出提问后，10分钟之内可以收回
            ### **收回稿**，指已发出提问，但已收回的提问
        1. 评价满意
            ### 初步提交
            ### 评价10分钟之后，正式提交，不再允许收回
        1. 评价不满意
            ### 初步提交
            ### 评价10分钟之后，正式提交，不再允许收回
        1. 收回评价
            ### 评价后，10分钟之内可以收回
            ### 收回后，可以重新评价
        1. 用户修改一项 CIA
            ### 在已发出提问后，用户可以修改提问的内容，包括正文、图像、声音
            ### 被修改后的提问，保存修改记录，专家或编导可以查看修改情况
        1. 删除
        1. 撤消删除
        1. 自动功能
            ### 发出提问10分钟后，正式提交
            ### 评价10分钟之后，正式提交
            ### 超时未评价，自动评价满意
    1. 专家操作
        1. 新建回答草稿
        1. 保存回答草稿
        1. 发出回答
        1. 收回回答，成为回答收回稿
        1. 不回答
    1. 编导操作
        1. 使用知识库进行回答
        1. 指定专家回答
        1. 增加一个关键词
        1. 减少一个关键词
        1. 归档
        1. 
        1. 编导修改一项 CIA
        1. 删除
        1. 撤消删除
1. 数据库
    1. 表名
        #### qa_data
    1. 字段SQL
           drop table if exists `qa_data`;
           create table `qa_data` (
             `id`         int(11) NOT NULL  AUTO_INCREMENT,
             `parentid`   int(11)          DEFAULT '0' COMMENT '0：提问;大于0：提问后的内容，包括回答和评价',
             `userid`     int(11)          DEFAULT '0' COMMENT '编辑这行数据的用户id',
             `rq`         varchar(32)      DEFAULT ''  COMMENT '提问：提交这行数据的时间，1999-99表示退回/收回稿; 回答：提交这行数据的时间; 评价：提交这行数据的时间',
             `senderid`   int(11)          DEFAULT '0' COMMENT '提问：归档操作的编导id; 回答：表示指定专家回答时的编导id; 评价：不用',
             `rq_send`    varchar(32)      DEFAULT ''  COMMENT '提问：不用; 回答：表示编导指定专家回答时的时间; 评价：不用。 提问中冗余，用于快速识别当前有有效专家在回答',
             `rq_timer`   varchar(32)      DEFAULT ''  COMMENT '',
             `rq_delete`  varchar(32)      DEFAULT ''  COMMENT '',
             `attr`       text                         COMMENT '',
             `state`      varchar(32)      DEFAULT ''  COMMENT '提问：归档时间; 回答：待回答、已回答、放弃回答、回答超时、用户满意、用户不满意; 评价：待评价、评价满意、评价不满意',
             primary key (`id`),
             unique key `id` (`id`),
             key `userid` (`userid`),
             key `rq_timer` (`rq_timer`),
             key `state` (`state`)
           )DEFAULT CHARSET=utf8;

    1. 一个完全的问答
        ### **提问**:             一行
        ### **不满意**（若干组）: 每组由若干行回答和一行不满意组成
        ### **满意**（一组）: 由若干行回答和一行不满意组成

    1. 概述

        提问、回答、评价等信息在同一数据表中；
        **提问**：每个一行；
        **回答**：每个一行；
        **评价**：每个一行；
        **归档**：与提问同一行，字段state为归档时间，有则表示已归档；
        修改、删除、收回、退回：在各行的attr字段中用json格式数据保存；

        注：每次增加一行，都要求满足条件。所以，按id顺序可显示整个流程。


1. 问答的状态
    1. 草稿

        用户未提问（qa.rq<'1999-99'）

    1. 退回/收回稿back

        用户收回提问或被退回（qa.rq='1999-99'）

    1. 准提问asking

        用户发出提问（qa.rq<=now - 10分钟）
        从未指定专家回答（没有parentid=qa.id的行）

    1. 新提问newask

        用户发出提问（qa.rq>now - 10分钟）
        从未指定专家回答（没有parentid=qa.id的行）

    1. 刚刚不满意unsatisfing

        最后一行为评价不满意
        评价时间未超过10分钟

    1. 不满意unsatisfy

        最后一行为评价不满意
        在10分钟前已评价

    1. 正在回答toanswer

        有state='待回答'的行

    1. 已全部放弃回答等待触发giveuping

        最后一行是放弃回答（state='放弃回答'）
        没有待评价的回答（state='待回答/已回答'）

    1. 已全部放弃回答可触发giveup

        最后一行是放弃回答（state='放弃回答'）
        没有待评价的回答（state='待回答/已回答'）

    1. 已全部回答等待触发评价answereding

        最后一行是回答或放弃回答（state IN ('放弃回答/已回答')）
        有已完成回答（state='已回答' AND rq>'2015-00'）
        无未完成回答（state='回答' AND rq<'2015-00'）

    1. 已全部回答可触发answered

        最后一行是回答或放弃回答（state IN ('放弃回答/已回答')）
        有已完成回答（state='已回答' AND rq>'2015-00'）
        无未完成回答（state='回答' AND rq<'2015-00'）
        触发后增加一评价行，转到状态“等待评价”

    1. 等待评价toassess

        最后一行是待评价（state='待评价'）

    1. 已评价待触发

        最后一行是已评价（state='评价满意/不满意'）
        用户可修改、撤消评价
        定时器时间到达后，触发：改写已回答行（state='用户满意/不满意'）

    1. 待归档tofile

        含有（state='用户满意'）的行

    1. 已归档filed

        qa.state>'2015-00'

1. 问答列表

    1. 用户

        1. 全部

            按rq排序，这样退/收回稿在最前
            qa.userid = me.id
            所有qa.rq>='1999-99'

        1. 未评价

            按id降序
            qa.userid = me.id
            最后一行是“待评价”

        1. 已评价

            按id降序
            qa.userid = me.id
            有“已评价”的行

    1. 专家

        1. 待回答

            按answer.rq_send降序
            answer.userid = me.id
            answer.state = '待回答'

        1. 我的回答

            按answer.rq降序
            answer.userid = me.id
            answer.state IN ('已回答','放弃回答','用户满意','用户不满意')

    1. 编导

        1. 全部

            按qa.id降序
            所有qa.rq>='1999-99'

        1. 新提问（包括不满意、全部放弃）

            没有任何回答，或
            最后一行是“用户不满意”且过了10分钟，或
            最后一行是“放弃”且没有“待回答”和“已回答”且所有放弃回答已过了10分钟

        1. 未回答

            有“待回答”

        1. 已回答

            最后一行是“待评价”

        1. 已评价

            最后一行是“评价满意”或“评价不满意”

        1. 已归档

            qa.state>'2015-00'



1. 类库
    1. 说明
        #### 不提供共用文件，以便部分升级或定制
        #### 各个模块自行复制 php 类
    1. SDK
           <?php
           class CMessage{
             function __construct($module, $db, $tableName = "g_message");
             //插入新的消息
             public function insert($text, $userid = "", $type = "", $target_url = "");
             //获取一行
             public function getRow($AND, $fields = false);
             //获取多行（列表）
             public function getList($AND, $fields = false);
             //获取待发送消息列表
             public function getToSendList($AND, $fields = false);
             //获取我的未读消息列表
             public function getMyUnreadedList($userid, $fields = false);
             //获取我的未读消息列表
             public function getMyReadedList($userid, $fields = false);
             //标志消息为已读
             public function markReaded($id);
             //标志消息为未读
             public function markUnReaded($id);
             //标志消息为已完成
             public function markDone($id);
             //标志消息为未完成
             public function markUnDone($id);
             //标志消息为已删除
             public function markDone($id);
             //标志消息为未删除
             public function markUnDone($id);
           }
    1. 说明



<style><span class="ui-helper-hidden">{} strong{color:#000;}  li{list-style-type:none;margin:0.5em 0 0.2em 0!important; line-height:1;font-size:0.9em;font-weight:500;} li h1,li h2,li h3,li h4,li h5,li>p:not(:first-child){font-size:14px;font-weight:500; line-height:1.33;margin:0.2em 0 0.2em 2em!important;color:#555;} li>p:first-child{display: inline;} body{counter-reset:h1;} body>ol>li{counter-reset:h2; font-size:26px;color:#00f; font-weight:900;} body>ol>li>ol>li{counter-reset:h3; color:#008;} body>ol>li>ol>li>ol>li{counter-reset:h4; color:#338;} body>ol>li>ol>li>ol>li>ol>li{counter-reset:h5; color:#558;} body>ol>li>ol>li>ol>li>ol>li>ol>li{counter-reset:h6; color:#555;} body>ol>li:before{ counter-increment:h1; content:counter(h1) ". ";} body>ol>li>ol>li:before{ counter-increment:h2; content:counter(h1) "." counter(h2) " ";} body>ol>li>ol>li>ol>li:before{ counter-increment:h3; content:counter(h1) "." counter(h2) "." counter(h3) " ";} body>ol>li>ol>li>ol>li>ol>li:before{ counter-increment:h4; content:counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) " ";} body>ol>li>ol>li>ol>li>ol>li>ol>li:before{ counter-increment:h5; content:counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) " ";}</span></style>




